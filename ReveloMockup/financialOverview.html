<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revelo - Financial Overview</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Nunito -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- DataTables.js for advanced tables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    

    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="style.css">
    
</head>
<body class="bg-gray-100 antialiased text-gray-800 pt-8">

    <!-- Organizer-specific Navbar -->
    <div id="organizer-navbar-placeholder"></div>

    <!-- Main container -->
    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <header class="mb-8">
            <nav class="text-sm mb-2" aria-label="Breadcrumb">
                <ol class="list-none p-0 inline-flex">
                    <li class="flex items-center">
                        <a href="organizerDashboard.html" class="text-gray-500 hover:text-revelo-blue">Organizer Dashboard</a>
                        <!-- Arrow SVG -->
                        <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569 9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
                    </li>
                    <li>
                        <span class="text-gray-700 font-semibold">Financial Overview</span>
                    </li>
                </ol>
            </nav>
            <div class="flex flex-col md:flex-row justify-between items-center">
                 <div>
                    <h1 class="text-3xl font-extrabold revelo-blue">Financial Overview</h1>
                    <p class="text-gray-500 mt-1">Your deep-dive financial analysis and accounting tool.</p>
                </div>
                 <a href="organizerDashboard.html" class="mt-4 md:mt-0 px-4 py-2 bg-revelo-blue text-white rounded-lg hover:bg-blue-800 transition duration-300 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Dashboard
                </a>
            </div>
        </header>

        <!-- 1. Payouts & Banking Section (Collapsible) -->
        <details class="bg-white rounded-lg shadow-lg mb-8" open>
            <summary class="flex justify-between items-center cursor-pointer font-bold text-2xl revelo-blue p-6">
                Payouts & Banking
                <svg class="w-6 h-6 transform transition-transform accordion-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="p-6 border-t border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Next Payout Card -->
                    <div id="next-payout-card" class="bg-gray-50 p-6 rounded-lg border col-span-1 md:col-span-1 flex flex-col justify-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase">NEXT PAYOUT</h3>
                        <p id="next-payout-amount" class="text-4xl font-extrabold revelo-blue mt-2">€0.00</p>
                        <p id="next-payout-date" class="text-gray-500 mt-1">Calculating...</p>
                    </div>
                    <!-- Payout Settings -->
                    <div class="bg-gray-50 p-6 rounded-lg border col-span-1 md:col-span-1 flex flex-col justify-center">
                         <h3 class="text-sm font-semibold text-gray-500 uppercase mb-2">PAYOUT SETTINGS</h3>
                         <p class="text-gray-700 font-semibold">Bank Account ending in ••••1234</p>
                         <button id="manage-payout-btn" class="mt-3 text-left text-sm font-bold text-revelo-orange hover:underline">Manage Payout Settings</button>
                    </div>
                    <!-- Payout History -->
                    <div class="bg-gray-50 p-6 rounded-lg border col-span-1 md:col-span-1 flex flex-col justify-center items-start">
                         <h3 class="text-sm font-semibold text-gray-500 uppercase mb-2">PAYOUT HISTORY</h3>
                         <p class="text-gray-600 mb-3">View all your past payouts and download statements.</p>
                         <button id="view-history-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">View History</button>
                    </div>
                </div>
            </div>
        </details>

        <!-- 2. Transaction Explorer Section (Collapsible) -->
        <details class="bg-white rounded-lg shadow-lg mb-8" open>
            <summary class="flex justify-between items-center cursor-pointer font-bold text-2xl revelo-blue p-6">
                Transaction Explorer
                <svg class="w-6 h-6 transform transition-transform accordion-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="p-6 md:p-8 border-t border-gray-200">
                <!-- Transactions Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white" id="transaction-explorer-table">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Event</th>
                                <th>Ticket</th>
                                <th>Attendee</th>
                                <th>Promoter</th>
                                <th>Code</th>
                                <th>Qty</th>
                                <th>Commission</th>
                                <th>Base</th>
                                <th>IVA</th>
                                <th>Gross</th>
                                <th>Fees</th>
                                <th>Net</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Payout ID</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- Rows will be dynamically inserted here -->
                            <tr>
                                <td colspan="18" class="text-center p-4">Loading transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </details>

        <!-- 3. Historical Analysis Section (Collapsible) -->
        <details class="bg-white rounded-lg shadow-lg mb-8" open>
            <summary class="flex justify-between items-center cursor-pointer font-bold text-2xl revelo-blue p-6">
                Historical Analysis
                <svg class="w-6 h-6 transform transition-transform accordion-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="p-6 border-t border-gray-200">
                <div class="flex space-x-2 mb-4 justify-center">
                    <input type="date" id="analysis-startDate" class="w-1/3 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-revelo-blue">
                    <input type="date" id="analysis-endDate" class="w-1/3 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-revelo-blue">
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Interactive Revenue Chart -->
                    <div class="lg:col-span-2 bg-gray-50 rounded-lg border p-6">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">Net Revenue Over Time</h3>
                        <div class="h-80">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <!-- Key Metrics Summary -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-6">
                        <div class="bg-gray-50 p-6 rounded-lg border">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase">Gross Sales</h4>
                            <p id="metric-gross-sales" class="text-3xl font-extrabold revelo-blue mt-2">€0.00</p>
                        </div>
                         <div class="bg-gray-50 p-6 rounded-lg border">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase">Refunds</h4>
                            <p id="metric-refunds" class="text-3xl font-extrabold text-red-600 mt-2">€0.00</p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg border">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase">Platform Fees</h4>
                            <p id="metric-platform-fees" class="text-3xl font-extrabold text-gray-700 mt-2">€0.00</p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg border">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase">Net Revenue</h4>
                            <p id="metric-net-revenue" class="text-3xl font-extrabold text-green-600 mt-2">€0.00</p>
                        </div>
                    </div>
                </div>
            </div>
        </details>

    </div>

    <!-- Modals -->
    <!-- Manage Payouts Modal -->
    <div id="managePayoutsModal" class="modal-overlay">
        <div class="modal-content">
            <!-- Padded inner container -->
            <div class="p-8 relative">
                <button id="closeManagePayoutsModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                <h2 class="text-2xl font-bold mb-2 revelo-blue">Manage Payout Settings</h2>
                <p class="text-gray-600 mb-6">Update your banking information for future payouts. Your current account ends in ••••1234.</p>
                <form class="space-y-4">
                    <div>
                        <label for="accountHolder" class="block text-sm font-semibold text-gray-700">Account Holder Name</label>
                        <input type="text" id="accountHolder" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" value="John Doe">
                    </div>
                    <div>
                        <label for="iban" class="block text-sm font-semibold text-gray-700">IBAN</label>
                        <input type="text" id="iban" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" value="ES9121000418450200051332">
                    </div>
                    <div>
                        <label for="bankName" class="block text-sm font-semibold text-gray-700">Bank Name</label>
                        <input type="text" id="bankName" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" value="Santander">
                    </div>
                    <div class="flex justify-end pt-4">
                        <button id="savePayoutChangesBtn" type="button" class="bg-revelo-blue text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-800 transition">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payout History Modal -->
    <div id="payoutHistoryModal" class="modal-overlay">
        <div class="modal-content max-w-3xl">
            <!-- Padded inner container -->
            <div class="p-8 relative">
                <button id="closePayoutHistoryModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                <h2 class="text-2xl font-bold mb-4 revelo-blue">Payout History</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payout ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="payoutsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Payout history rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- MODAL & GLOBAL FUNCTIONS (NON-CONFLICTING) ---
        function openFinancialModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('visible');
            }
        }

        function closeFinancialModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('visible');
            }
        }
        
        window.addEventListener('load', () => {
            // The JSON file is expected to be in a 'data' sub-folder
            const JSON_URL = './data/transactions.json';

            // --- STATE MANAGEMENT ---
            let allTransactions = [];
            let revenueChart = null;
            let transactionTable;
            
            const payoutHistoryData = [
                { id: 'POUT-202406-01', date: '2024-06-07', amount: 2005.15, status: 'Completed' },
                { id: 'POUT-202407-15', date: '2024-07-16', amount: 4500.80, status: 'Completed' },
                { id: 'POUT-202408-20', date: '2024-08-21', amount: 1532.00, status: 'Completed' },
            ];
            
            // --- DOM ELEMENTS ---
            const analysisStartDateInput = document.getElementById('analysis-startDate');
            const analysisEndDateInput = document.getElementById('analysis-endDate');
            const managePayoutsBtn = document.getElementById('manage-payout-btn');
            const viewHistoryBtn = document.getElementById('view-history-btn');
            const payoutsTableBody = document.getElementById('payoutsTableBody');
            
            // Modal Buttons
            const closeManagePayoutsModalBtn = document.getElementById('closeManagePayoutsModalBtn');
            const savePayoutChangesBtn = document.getElementById('savePayoutChangesBtn');
            const closePayoutHistoryModalBtn = document.getElementById('closePayoutHistoryModalBtn');


            // --- UTILITY FUNCTIONS ---
            const formatCurrency = (value) => {
                const num = parseFloat(value || 0);
                if (isNaN(num)) return '€0.00';
                return `€${num.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };

            const formatDate = (date) => {
                if (!(date instanceof Date) || isNaN(date.getTime())) {
                    return '';
                }
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            // --- DATA FETCHING & INITIALIZATION ---
            async function loadAndProcessData() {
                try {
                    const response = await fetch(JSON_URL);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const rawData = await response.json();
                    
                    if (rawData && rawData.length > 0) {
                        allTransactions = rawData.map(row => {
                            const newRow = {};
                            for(const key in row) {
                                let value = row[key];
                                if (['Promoter_Commission', 'Base', 'IVA', 'Gross_Amount', 'Fees', 'Net_Amount', 'Qty'].includes(key)) {
                                    const parsedValue = parseFloat(value);
                                    value = isNaN(parsedValue) ? 0 : parsedValue;
                                } else if (key === 'Transaction_Date') {
                                    const datePart = value.split(' ')[0];
                                    value = new Date(datePart);
                                }
                                newRow[key] = value;
                            }
                            return newRow;
                        });
                        
                        initializeApp();
                    } else {
                        console.error("JSON file is empty or invalid.");
                        document.getElementById('transactionsTableBody').innerHTML = `<tr><td colspan="18" class="text-center p-4 text-red-500">JSON file is empty or invalid.</td></tr>`;
                    }
                } catch (error) {
                    console.error("Error fetching JSON:", error);
                    document.getElementById('transactionsTableBody').innerHTML = `<tr><td colspan="18" class="text-center p-4 text-red-500">Error loading data. Please check the file path and make sure the file is available at <strong>${JSON_URL}</strong>.</td></tr>`;
                }
            }
            
            function initializeApp() {
                if (allTransactions.length === 0) {
                     document.getElementById('transactionsTableBody').innerHTML = `<tr><td colspan="18" class="text-center p-4">No transactions to display.</td></tr>`;
                    return;
                }
                
                const dates = allTransactions.map(t => t.Transaction_Date).filter(d => d instanceof Date && !isNaN(d));
                if (dates.length > 0) {
                    const minDate = formatDate(new Date(Math.min(...dates)));
                    const maxDate = formatDate(new Date(Math.max(...dates)));
                    analysisStartDateInput.value = minDate;
                    analysisEndDateInput.value = maxDate;
                }
                
                calculateNextPayout();
                renderTransactionTable(allTransactions);
                applyFiltersAndRenderAnalysis();
            }
            
            function calculateNextPayout() {
                const latestPayoutId = allTransactions.reduce((latest, t) => {
                    if (!t.Payout_ID) return latest;
                    if (!latest) return t.Payout_ID;
                    return t.Payout_ID > latest ? t.Payout_ID : latest;
                }, '');

                if (!latestPayoutId) {
                     document.getElementById('next-payout-amount').textContent = '€0.00';
                     document.getElementById('next-payout-date').textContent = 'No payouts found';
                     return;
                }

                const nextPayoutTransactions = allTransactions.filter(t => t.Payout_ID === latestPayoutId);
                const totalNet = nextPayoutTransactions.reduce((sum, t) => sum + (t.Net_Amount || 0), 0);
                
                document.getElementById('next-payout-amount').textContent = formatCurrency(totalNet);
                
                const parts = latestPayoutId.split('-');
                if (parts.length === 3) {
                    const year = parts[1].substring(0, 4);
                    const month = parts[1].substring(4, 6) - 1;
                    const day = parts[2];
                    const date = new Date(year, month, day);
                    document.getElementById('next-payout-date').textContent = `On ${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
                } else {
                     document.getElementById('next-payout-date').textContent = `On ${latestPayoutId}`;
                }
            }

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                // Page listeners
                analysisStartDateInput.addEventListener('change', applyFiltersAndRenderAnalysis);
                analysisEndDateInput.addEventListener('change', applyFiltersAndRenderAnalysis);
                
                // Modal open listeners
                managePayoutsBtn.addEventListener('click', () => openFinancialModal('managePayoutsModal'));
                viewHistoryBtn.addEventListener('click', openPayoutsHistoryModal);
                
                // Modal close listeners
                closeManagePayoutsModalBtn.addEventListener('click', () => closeFinancialModal('managePayoutsModal'));
                savePayoutChangesBtn.addEventListener('click', () => closeFinancialModal('managePayoutsModal'));
                closePayoutHistoryModalBtn.addEventListener('click', () => closeFinancialModal('payoutHistoryModal'));
            }

            // --- FILTERING, SORTING, AND RENDERING ---
            function applyFiltersAndRenderAnalysis() {
                const analysisStartDate = new Date(analysisStartDateInput.value);
                const analysisEndDate = new Date(analysisEndDateInput.value);
                analysisEndDate.setHours(23, 59, 59, 999);
                const analysisFilteredTransactions = allTransactions.filter(t => {
                    return t.Transaction_Date instanceof Date && !isNaN(t.Transaction_Date.getTime()) && t.Transaction_Date >= analysisStartDate && t.Transaction_Date <= analysisEndDate;
                });

                updateMetrics(analysisFilteredTransactions);
                renderChart(analysisFilteredTransactions);
            }

            // --- TABLE & PAGINATION ---
            function renderTransactionTable(data) {
                if (transactionTable) {
                    transactionTable.destroy();
                }
                
                transactionTable = $('#transaction-explorer-table').DataTable({
                    data: data,
                    columns: [
                        { data: 'Transaction_ID' },
                        { data: 'Transaction_Date', render: (d) => d ? new Date(d).toLocaleDateString() : '' },
                        { data: 'Transaction_Type' },
                        { data: 'Event_Name' },
                        { data: 'Ticket_Type' },
                        { data: 'Attendee_Name' },
                        { data: 'Promoter_Name' },
                        { data: 'Discount_Code_Used', defaultContent: '' },
                        { data: 'Qty' },
                        { data: 'Promoter_Commission', render: (d) => formatCurrency(d) },
                        { data: 'Base', render: (d) => formatCurrency(d) },
                        { data: 'IVA', render: (d) => formatCurrency(d) },
                        { data: 'Gross_Amount', render: (d) => formatCurrency(d) },
                        { data: 'Fees', render: (d) => formatCurrency(d) },
                        { data: 'Net_Amount', render: (d) => formatCurrency(d) },
                        { data: 'Payment_Method' },
                        { data: 'Status' },
                        { data: 'Payout_ID' }
                    ],
                    dom: "lBfrtip",
                    buttons: [
                        {
                            extend: 'collection',
                            text: 'Export',
                            buttons: [
                                'csv',
                                'excel',
                                'pdf'
                            ]
                        }
                    ],
                    initComplete: function () {
                        var table = this.api();
                        
                        // Add date filters
                        var dateFilterHtml = `
                            <div class="inline-flex items-center space-x-2 ml-4">
                                <label for="startDate">From:</label>
                                <input type="date" id="startDate" class="border border-gray-300 rounded-md p-1">
                                <label for="endDate">To:</label>
                                <input type="date" id="endDate" class="border border-gray-300 rounded-md p-1">
                            </div>
                        `;
                        $('.dataTables_filter').prepend(dateFilterHtml);

                        $('#startDate, #endDate').on('change', function() {
                            table.draw();
                        });

                        $.fn.dataTable.ext.search.push(
                            function(settings, data, dataIndex) {
                                var min = $('#startDate').val();
                                var max = $('#endDate').val();
                                var date = new Date(data[1]);

                                if (
                                    (min === "" || new Date(min) <= date) &&
                                    (max === "" || new Date(max) >= date)
                                ) {
                                    return true;
                                }
                                return false;
                            }
                        );

                        table.columns().every(function (idx) {
                            var column = this;
                            var header = $(column.header());
                            var title = header.text();
                            
                            // Make header font smaller
                            header.css('font-size', '0.875rem');

                            header.html(title + ' <span class="filter-icon"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="Interface / Filter"> <path id="Vector" d="M20 5.6001C20 5.04005 19.9996 4.75981 19.8906 4.5459C19.7948 4.35774 19.6423 4.20487 19.4542 4.10899C19.2403 4 18.9597 4 18.3996 4H5.59961C5.03956 4 4.75981 4 4.5459 4.10899C4.35774 4.20487 4.20487 4.35774 4.10899 4.5459C4 4.75981 4 5.04005 4 5.6001V6.33736C4 6.58195 4 6.70433 4.02763 6.81942C4.05213 6.92146 4.09263 7.01893 4.14746 7.1084C4.20928 7.20928 4.29591 7.29591 4.46875 7.46875L9.53149 12.5315C9.70443 12.7044 9.79044 12.7904 9.85228 12.8914C9.90711 12.9808 9.94816 13.0786 9.97266 13.1807C10 13.2946 10 13.4155 10 13.6552V18.411C10 19.2682 10 19.6971 10.1805 19.9552C10.3382 20.1806 10.5814 20.331 10.8535 20.3712C11.1651 20.4172 11.5487 20.2257 12.3154 19.8424L13.1154 19.4424C13.4365 19.2819 13.5966 19.2013 13.7139 19.0815C13.8176 18.9756 13.897 18.8485 13.9453 18.7084C14 18.5499 14 18.37 14 18.011V13.6626C14 13.418 14 13.2958 14.0276 13.1807C14.0521 13.0786 14.0926 12.9808 14.1475 12.8914C14.2089 12.7911 14.2947 12.7053 14.4653 12.5347L14.4688 12.5315L19.5315 7.46875C19.7044 7.2958 19.7904 7.20932 19.8523 7.1084C19.9071 7.01893 19.9482 6.92146 19.9727 6.81942C20 6.70551 20 6.58444 20 6.3448V5.6001Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g> </g></svg></span>');

                            header.find('.filter-icon').on('click', function (e) {
                                e.stopPropagation();
                                $('.filter-modal').remove(); 

                                var modal = $(`<div class="filter-modal"></div>`).appendTo('body');
                                modal.css({
                                    top: header.offset().top + header.outerHeight(),
                                    left: header.offset().left
                                });
                                
                                var searchStr = column.search().replace(/[\^\$]/g, '').split('|');
                                var currentFilter = searchStr.filter(v => v !== "");

                                var values = column.data().unique().sort().toArray();
                                
                                var optionsContainer = $('<div class="options-container"></div>').appendTo(modal);
                                optionsContainer.append(`<div><label><input type="checkbox" class="select-all"> Select All</label></div><hr class="my-1">`);
                                
                                values.forEach(function (value) {
                                    if (value !== null) {
                                        var isChecked = currentFilter.length === 0 || currentFilter.includes(String(value).replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1"));
                                        optionsContainer.append(`<div><label><input type="checkbox" class="filter-value" value="${value}" ${isChecked ? 'checked' : ''}> ${value || '(Empty)'}</label></div>`);
                                    }
                                });
                                
                                var allChecked = optionsContainer.find('.filter-value:not(:checked)').length === 0;
                                optionsContainer.find('.select-all').prop('checked', allChecked);


                                modal.append(`<div class="mt-2 flex justify-end space-x-2"><button class="cancel-filter-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm">Cancel</button><button class="apply-filter-btn bg-revelo-blue text-white px-3 py-1 rounded-md text-sm">Apply</button></div>`);
                                modal.show();

                                modal.find('.select-all').on('change', function () {
                                    var isChecked = $(this).is(':checked');
                                    modal.find('.filter-value').prop('checked', isChecked);
                                });

                                modal.find('.apply-filter-btn').on('click', function () {
                                    var selectedValues = [];
                                    modal.find('.filter-value:checked').each(function () {
                                        selectedValues.push('^' + $.fn.dataTable.util.escapeRegex($(this).val()) + '$');
                                    });
                                    column.search(selectedValues.join('|'), true, false).draw();
                                    modal.remove();
                                });

                                modal.find('.cancel-filter-btn').on('click', function () {
                                    modal.remove();
                                });
                            });
                        });

                        // Add Reset Filters button next to the search field
                        var resetButton = $('<button id="resetFilters" class="dt-button bg-revelo-orange hover:bg-orange-600" style="margin-left: 10px;">Reset Filters</button>')
                            .on('click', function() {
                                transactionTable.search('').columns().search('').draw();
                                $('.dataTables_filter input').val('');
                                $('#startDate, #endDate').val('');
                                transactionTable.draw();
                            });
                        $('.dataTables_filter').append(resetButton);
                    }
                });

                $(document).on('click', function (e) {
                    if (!$(e.target).closest('.filter-modal, .filter-icon').length) {
                        $('.filter-modal').remove();
                    }
                });
            }

            // --- METRICS & CHART ---
            function updateMetrics(data) {
                let grossSales = 0;
                let refunds = 0;
                let platformFees = 0;
                let netRevenue = 0;

                data.forEach(t => {
                    if (t.Transaction_Type === 'Sale') {
                        grossSales += (t.Gross_Amount || 0);
                    } else if (t.Transaction_Type === 'Refund') {
                        refunds += (t.Gross_Amount || 0);
                    }
                    platformFees += (t.Fees || 0);
                    netRevenue += (t.Net_Amount || 0);
                });

                document.getElementById('metric-gross-sales').textContent = formatCurrency(grossSales);
                document.getElementById('metric-refunds').textContent = formatCurrency(refunds);
                document.getElementById('metric-platform-fees').textContent = formatCurrency(platformFees);
                document.getElementById('metric-net-revenue').textContent = formatCurrency(netRevenue);
            }

            function renderChart(data) {
                const ctx = document.getElementById('revenueChart').getContext('2d');
                
                const salesByDate = data.reduce((acc, t) => {
                    if(t.Transaction_Date && !isNaN(t.Transaction_Date.getTime())) {
                        const date = t.Transaction_Date.toISOString().split('T')[0];
                        if (!acc[date]) {
                            acc[date] = 0;
                        }
                        acc[date] += (t.Net_Amount || 0);
                    }
                    return acc;
                }, {});

                const sortedDates = Object.keys(salesByDate).sort();
                const chartData = sortedDates.map(date => ({ x: date, y: salesByDate[date] }));

                if (revenueChart) {
                    revenueChart.data.labels = sortedDates;
                    revenueChart.data.datasets[0].data = chartData;
                    revenueChart.update();
                } else {
                    revenueChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: sortedDates,
                            datasets: [{
                                label: 'Net Revenue',
                                data: chartData,
                                borderColor: '#213c63',
                                backgroundColor: 'rgba(33, 60, 99, 0.1)',
                                fill: true,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'day',
                                        tooltipFormat: 'MMM dd, yyyy'
                                    },
                                    title: { display: false }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: { display: false },
                                    ticks: {
                                        callback: (value) => formatCurrency(value)
                                    }
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `Net Revenue: ${formatCurrency(context.raw.y)}`
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // --- PAYOUT HISTORY MODAL ---
            function renderPayoutsTable() {
                payoutsTableBody.innerHTML = payoutHistoryData.map(payout => {
                    const statusClass = payout.status === 'Completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${payout.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${payout.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">${formatCurrency(payout.amount)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${payout.status}</span>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            function openPayoutsHistoryModal() {
                renderPayoutsTable();
                openFinancialModal('payoutHistoryModal');
            }

            // --- SETUP LISTENERS THAT DON'T DEPEND ON DATA ---
            setupEventListeners();

            // --- START THE APP'S DATA-DEPENDENT PARTS ---
            loadAndProcessData();
        });
    </script>
    <!-- Assuming you have a separate organizer.js file that handles navbar logic -->
    <script src="organizer.js" defer></script>
</body>
</html>
